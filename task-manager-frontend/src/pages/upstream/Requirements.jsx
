// RequirementsPage.jsx â€• ã‚¹ãƒ†ãƒƒãƒ—â‘¡ï¼šè¦æ±‚å®šç¾©
import React, { useEffect, useState } from 'react';
import { API_BASE_URL } from '../../App';
import './UpstreamCommon.css';         // æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«

export default function RequirementsPage() {
  const [rows,    setRows]    = useState([]);
  const [loading, setLoading] = useState(true);

  /* ---------- åˆæœŸãƒ­ãƒ¼ãƒ‰ ---------- */
  useEffect(() => { load(); }, []);
  const load = async () => {
    setLoading(true);
    try {
      const r = await fetch(`${API_BASE_URL}/requirements`);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      setRows(await r.json());
    } catch (e) {
      console.error('âŒ è¦æ±‚å–å¾—å¤±æ•—:', e);
      alert('è¦æ±‚ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally { setLoading(false); }
  };

  /* ---------- è¡Œè¿½åŠ  ---------- */
  const handleAdd = async () => {
    const blank = { title:'', type:'FR', priority:'M', status:'æ¤œè¨ä¸­', notes:'' };
    const r     = await fetch(`${API_BASE_URL}/requirements`, {
      method : 'POST',
      headers: { 'Content-Type':'application/json' },
      body   : JSON.stringify(blank)
    });
    if (r.ok) load();
  };

  /* ---------- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›† ---------- */
  const upd = (id, key, val) => setRows(rows.map(x=>x.id===id?{...x,[key]:val}:x));
  const save = row => fetch(`${API_BASE_URL}/requirements/${row.id}`, {
    method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(row)
  });

  /* ---------- å‰Šé™¤ ---------- */
  const del = async id =>{
    if(!window.confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    await fetch(`${API_BASE_URL}/requirements/${id}`,{method:'DELETE'});
    load();
  };

  if (loading) return <p>èª­ã¿è¾¼ã¿ä¸­â€¦</p>;

  /* ---------- æç”» ---------- */
  return (
    <div className="up-card">
      <h2>ğŸ“ è¦æ±‚å®šç¾©</h2>

      <table className="up-table">
        <thead>
          <tr>
            <th>è¦æ±‚ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>ç¨®åˆ¥</th>
            <th>å„ªå…ˆåº¦</th>
            <th>çŠ¶æ…‹</th>
            <th>å‚™è€ƒ</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {rows.map(r=>(
            <tr key={r.id}>
              <td><input value={r.title}
                         onChange={e=>upd(r.id,'title',e.target.value)}
                         onBlur={()=>save(r)} /></td>

              <td>
                <select value={r.type}
                        onChange={e=>{upd(r.id,'type',e.target.value); save({...r,type:e.target.value});}}>
                  <option value="FR">FR</option>
                  <option value="NFR">NFR</option>
                </select>
              </td>

              <td>
                <select value={r.priority}
                        onChange={e=>{upd(r.id,'priority',e.target.value); save({...r,priority:e.target.value});}}>
                  <option value="H">H</option>
                  <option value="M">M</option>
                  <option value="L">L</option>
                </select>
              </td>

              <td>
                <select value={r.status}
                        onChange={e=>{upd(r.id,'status',e.target.value); save({...r,status:e.target.value});}}>
                  <option value="æ¤œè¨ä¸­">æ¤œè¨ä¸­</option>
                  <option value="æ‰¿èª">æ‰¿èª</option>
                  <option value="å´ä¸‹">å´ä¸‹</option>
                </select>
              </td>

              <td><input value={r.notes}
                         onChange={e=>upd(r.id,'notes',e.target.value)}
                         onBlur={()=>save(r)} /></td>

              <td><button onClick={()=>del(r.id)}>ğŸ—‘</button></td>
            </tr>
          ))}
        </tbody>
      </table>

      <button className="add-btn" onClick={handleAdd}>â• è¡Œã‚’è¿½åŠ </button>
    </div>
  );
}